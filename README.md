# `PRISMA ORM` AND POSTGRES

THIS GUIDE IS HELPFUL

<https://dev.to/prisma/set-up-a-free-postgresql-database-on-supabase-to-use-with-prisma-3pk6>

AND MAYBE YOU CAN WATCH THIS VIDEO

<https://www.youtube.com/watch?v=mU8-nKwfw4Y&t=21s>

**BUT YOU ALSO HAVE OFFICIAL TUTORIAL FOR PRISMA TYPESCRIPT AND POSTGRES**

## THIS IS PRISMAS PAGE

<https://www.prisma.io/>

WHERE I FOUND MENTIONED GUIDE:

<https://www.prisma.io/docs/getting-started/setup-prisma/start-from-scratch/relational-databases-typescript-postgres>

## BUT ALSO NEXTJS HAS VERY GOOD TUTORIAL

<https://vercel.com/guides/nextjs-prisma-postgres>

WHICH INCLUDES MANY MORE THINGS (ONE OF THEM IS NEXT-AUTH)

# FIRST LET'S BACKUP SOME FILES, BECAUSE WHEN WE EXECUTE PRISMA INITIALIZATION, SOME FILES WILL BE OVERWRITTEN

WE WILL BACK UP: .gitignore (RENAME IT TO gitignore WITHOUT DOT)

THAT'S ALL BECAUSE WE DON'T HAVE .env (WHICH WILL ALSO BE GENERATED)

# LETS START BY INSTALLING PRISMA

```
yarn add prisma
```

# WE CAN'T USE PRISMA WITH EXISTING SUPABASE DATBASE FOR ONE REASON, AND THAT REASON ARE CROSS DATBASE FORGEIN KEYS

IN OUR CURRENT SETUP WE HAVE TWO DATBASES

WE HAVE ONE WITH ONLY Posts TABLE; AND THE OTHER DATBASE IS ONE FOR SUPABASE AUUT

WE HAVE Posts TABLE RIGHT NOW, WHICH WE CREATED LONG TIME AGO BY USING `CREATE TABLE` CLAUSE, WHERE WE ALSO SPECIFIED THAT

**BUT INSIDE THAT TABLE WE SPECIFIED FORGEIN KEY**

**AND ONLY PROBLEM IS THAT MENTIONED FORGEN KEY POINTS OR REFERENCES TO Users TABLE, `A TABLE WHICH IS INCIDENTALLY A TABLE FROM ANOTHER DATBASE`**

```sql
CREATE TABLE posts(
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  -- SEE, WE DID THAT HERE
  user_id UUID REFERENCES auth.users NOT NULL,
  -- 
  user_email TEXT,
  title TEXT,
  content TEXT,
  inserted_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::TEXT, NOW()) NOT NULL
);

--

ALTER TABLE posts ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Individuals can create posts." ON posts FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Individuals can update their own posts." ON posts FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Individuals can delete their own posts." ON posts FOR DELETE USING (auth.uid() = user_id);
CREATE POLICY "Post are public." ON posts FOR SELECT USING (true);
```

**PROBLEM IS THAT PRISMA CURRENTLY DOEN'T SUPPORT FORGEN KEYS THAT ARE WITH CROSS DATABASE ORIGIN**

IF WE WOULD PROCED TO USE PRISMA, DESPITE THING I MENTIONED, **WE WOULD END UP WITH THESE KINDS OF ERRORS WHEN WE EVENT TRY USING PRISMA STUFF**

<https://github.com/prisma/prisma/issues/1122>

# NOW LETS INITIALIZE PRISMA, AND THEN LETS ADD URL OF OUR POSTGRES INSTANE AS AN ENV VARIABLE

```
npx prisma init
```

WE HAVE GOT `.gitignore`, `.env` AND `prisma/schema.prisma`

WE CAN REMOVE THAT .gitignore FILE AND CHANGE NAME OF gitignore FILE .gitignore (WE ARE REMOVING THAT FILE BECAUSE IT BRINGS NOTHING IMPORTANT)

WE CAN ALSO REMOVE .env FILE BUT BEFORE THAT, WE MOVE ITS CONTENT TO `.env.local`

.env

```py
# Environment variables declared in this file are automatically made available to Prisma.
# See the documentation for more detail: https://pris.ly/d/prisma-schema#using-environment-variables

# Prisma supports the native connection string format for PostgreSQL, MySQL, SQLite, SQL Server (Preview) and MongoDB (Preview).
# See the documentation for all the connection string options: https://pris.ly/d/connection-strings

DATABASE_URL="postgresql://johndoe:randompassword@localhost:5432/mydb?schema=public"
```

LIKE YOU SEE ABOVE ARE OME PLACEHOLDER URL THAT ONLY EXPLAINS WHAT VARIABLE YOU SHOULD SET

**SO WE REMOVED .env AND ADDED CODE ABOVE, TO THE `.env.local`**

**AND WE SPECIFIED URL OF OUR UPABASE DATBASE**

`.env.local` :

```py
# WHEN WE USE SUPABASE CLIENT WE USE THESE TWO
# THIS IS NOT RELEVENT NOW
NEXT_PUBLIC_SUPABASE_ANON_KEY=
NEXT_PUBLIC_SUPABASE_URL=

# WE USED THIS EARLIER URL WHEN WE TRYED OUT QUERYING
# BY USING node-postgres
POSTGRES_URL=

# ---------------- WE ADDED THIS NOW -----------------

# Environment variables declared in this file are automatically made available to Prisma.
# See the documentation for more detail: https://pris.ly/d/prisma-schema#using-environment-variables

# Prisma supports the native connection string format for PostgreSQL, MySQL, SQLite, SQL Server (Preview) and MongoDB (Preview).
# See the documentation for all the connection string options: https://pris.ly/d/connection-strings

# WHEN WE CREATE NEW SUPABASE PROJECT WE WILL DD DABASE URL IN HERE
DATABASE_URL=<WE WILL ADD URL OF NEW SUPABASE DATABASE>
```

# LETS'S CREATE NEW PROJECT ON SUPABASE (LIKE WE DID IN HERE)



# LETS REVIEW A LITLE BIT, GENERATED FILE `prisma/schema.prisma`

SO, THIS FILE REPRESENTS MAIN PRISMA CONFIGURATION

WE CAN SEE THAT URL WILL BE OBTAIND FROM ENV VARIBLE WE SETTE UP

WE CAN SEE THAT PROVIDER IS PostgreSQL (TYPE OF DATASOURCE)

AND WE CAN SE THAT AT THE END CLIENT IS GOING TO BE GENERATED FOR US TO DO QUERY AN MUTATIONS AND NAME OF THE CLIENT IS prisma-client-js

```
cat prisma/schema.prisma
```

```ts
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}
```

**IN NEXT BRANCH WE WILL CREATE OUR DATBASE SCHEMA, AND WE WILL DO THAT BY ADDING DEFINITIONS TO FILE ABOVE**